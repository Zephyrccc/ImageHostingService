# Tomcat

## 身份鉴别

### 检测项a

[重要]应对登录的用户进行身份标识和鉴别，身份标识具有唯一性，身份鉴别信息具有复杂度要求并定期更换；

检测步骤

- 确认是否使用了tomcat管理后台

  - 找到配置文件：tomcat主目录下/conf/server.xml

    ```shell
    cat /opt/tomcat/conf/server.xml
    # 查看连接端口 例如：
    # <Connector port="8080" protocol="HTTP/1.1"
    #                connectionTimeout="20000"
    #                redirectPort="8443"
    #                maxParameterCount="1000"
    #                />
    ```

- 然后查看manager-gui管理页面配置文件，是否设置了用户登录

  ```shell
  # 路径为tomcat主目录下/conf/tomcat-users.xml
  cat /opt/tomcat/conf/tomcat-users.xml
  ls -liah /opt/tomcat/conf/tomcat-users.xml
  # 是否存在如下配置：
  # <role rolename="manager-gui"/>
  # <user username="tomcat" password="tomcat" roles="manager-gui"/>
  ```

### 检测项b

[重要]应具有登录失败处理功能，应配置并启用结束会话、限制非法登录次数和当登录连接超时自动退出等相关措施；

检测步骤

- 查看tomcat主目录下/conf/server.xml

  ```shell
  cat /software/tomcat/conf/server.xml | grep LockOutRealm
  cat /software/tomcat/conf/server.xml | grep session-timeout
  cat /software/tomcat/conf/server.xml
  ```

  查看文件是否有如下配置

  ```xml
  <Context>
    <!-- ... 其他配置 ... -->
    <Realm className="org.apache.catalina.realm.LockOutRealm">
      <Realm className="org.apache.catalina.realm.UserDatabaseRealm" resourceName="UserDatabase"/>
      <LockOutRealm failureCount="3" lockOutTime="300"/>
    </Realm>
    <session-config>
      <session-timeout>30</session-timeout>
    </session-config>
  </Context>
  ```

### 检测项c

[关键]当进行远程管理时，应采取必要措施防止鉴别信息在网络传输过程中被窃听；

检测步骤

- 查看传输协议是http还是https即可 

### 检测项d

[关键]应采用口令、密码技术、生物技术等两种或两种以上组合的鉴别技术对用户进行身份鉴别，且其中一种鉴别技术至少应使用密码技术来实现。

检测步骤

- 一般采用堡垒机双因子实现

## 访问控制

### 检测项a

[重要]应对登录的用户分配账户和权限；

检测步骤

- 在tomcat目录下/conf/tomcat-user.xml，查看有哪些用户，分别为什么角色

  ```shell
  cat /opt/tomcat/conf/tomcat-users.xml
  ```

### 检测项b

[重要]应重命名或删除默认账户，修改默认账户的默认口令；

常见结果描述

检测步骤

- 查看tomcat目录下/conf/tomcat-user.xml是否存在 admin、manager、tomcat、role1、both等默认账户，口令是否为默认口令等

  ```shell
  cat /opt/tomcat/conf/tomcat-users.xml
  ```

### 检测项c

[重要]应及时删除或停用多余的、过期的账户，避免共享账户的存在；

检测步骤

- 查看tomcat目录下/conf/tomcat-user.xml文件，确认现有账户有哪些，并询问管理人员每个账户的用途事什么，确认是否存在多余账户。

  ```shell
  cat /opt/tomcat/conf/tomcat-users.xml
  ```

### 检测项d

[一般]应授予管理用户所需的最小权限，实现管理用户的权限分离；

检测步骤

1. 三权分立原则
2. 按最小授权原则分配，管理用户的权限分离，对于中间件来说应该实现不了

### 检测项e

[一般]应由授权主体配置访问控制策略，访问控制策略规定主体对客体的访问规则；

检测步骤

- 查看tomcat目录下/conf/tomcat-user.xml，确认管理员对各用户的访问控制规则，即设置的对应角色

  各用户的角色权限:

  1. role1：具有读权限；
  2. tomcat：具有读和运行权限；
  3. admin：具有读、运行和写权限；
  4. manager：具有远程管理权限。

  Tomcat 6.0.18版本只有admin和manager两种用户角色，且admin用户具有manager管理权限。

  Tomcat 4.1.37和5.5.27版本及以后发行的版本默认除admin用户外其他用户都不具有manager管理权限。

  Manager目录为缺省管理目录，若系统上线后不需要通过web页面管理，可删除（移除）此目录，这样相对更为安全。

### 检测项f

[一般]访问控制的粒度应达到主体为用户级或进程级，客体为文件、数据库表级；

常见结果描述

不适用

- 一般判断此项不适用。

### 检测项g

[一般]应对重要主体和客体设置安全标记，并控制主体对有安全标记信息资源的访问。

常见结果描述

不适用

- 一般判断此项不适用。

## 安全审计

### 检测项a

[重要]应启用安全审计功能，审计覆盖到每个用户，对重要的用户行为和重要安全事件进行审计；

检测步骤

- 查看Tomcat安装目录/conf/logging.properties文件: 

  ```shell
  cat /opt/conf/logging.properties | grep FINE
  cat /opt/conf/logging.properties
  ```

  1. catalina.org.apache .juli.FileHandler.level=FINE(开启Cat aine引擎的日志文件)；

  2. localhost.org.apache.jul.File Handler.level=FINE(开启内部代码丢出的日志)；

  3. manager.org.apache juli.File Handler.level=FINE(开启manager应用日志)；

  4. java.uti.ogg ing.Console Handler.level=FINE(开启控制台输出的日志)；

  5. host-manager.org.apache.juli.AsyncFileHandler.level=FINE(开启主机管理日志)

  6. 查看Tomcat安装目录/conf/server.xml

     ```shell
     cat /opt/conf/server.xml
     ```

     是否将以下内容的注释标记**取消**

     ```xml
     <Valve className="org.apache.catalina.valves.AccessLogValve" directory="logs"
             prefix="localhost_access_log" suffix=".txt"
             pattern="%h %l %u %t &quot;%r&quot; %s %b" />
     ```

  7. 查看操作系统是否开启了安全审计功能；

  8. 询问并查看是否有第三方审计工具或系统； 

### 检测项b

[一般]审计记录应包括事件的日期和时间、用户、事件类型、事件是否成功及其他与审计相关的信息；

检测步骤

- 确认系统当前时间

  ```shell
  date
  ```

- 查看日志

  ```shell
  ls -liah /opt/tomcat/logs
  tail -10 /opt/tomcat/logs/catalina.*.log
  tail -10 /opt/tomcat/logs/catalina.out
  tail -10 /opt/tomcat/logs/host-manager.*.log
  tail -10 /opt/tomcat/logs/localhost.*.log
  tail -10 /opt/tomcat/logs/manager.*.log
  tail -10 /opt/tomcat/logs/localhost_access_log.*.txt
  head -10 /opt/tomcat/logs/localhost_access_log.*.txt #查看一条日志信息，观察是否满足等保要求
  ```

### 检测项c

[一般]应对审计记录进行保护，定期备份，避免受到未预期的删除、修改或覆盖等；

检测步骤

- 查看日志文件权限

  ```shell
  ls -liah /opt/tomcat/logs #不高于640
  ```

- 询问管理人员是否定期备份该中间件的日志信息

  - 若是实时传输的，查看传输设备上的相关权限，比如传输到日志服务器，仅审计管理员具有记录查看权限等。

- 查看日志文件的保存周期

  - 重要设备的日志留存时间要达到6个月以上。

- 使用第三方软件对日志进行保护。  

### 检测项d

[一般]应对审计进程进行保护，防止未经授权的中断。

预期结果

符合

- 审计进程与中间件主进程关联，无法单独中断审计进程，只要开启日志审计即可判为符合；如使用第三方的保护程序也可判为符合。   

## 入侵防范

### 检测项a

[重要]应遵循最小安装的原则，仅安装需要的组件和应用程序；

常见结果描述

不适用

- 根据《信息安全技术 网络安全等级保护测评要求》（GB/T 28448-2019），中间件对应该测评项无相关判定需求，因此该项不适用。

### 检测项b

[关键]应关闭不需要的系统服务、默认共享和高危端口；

常见结果描述

不适用

- 根据《信息安全技术 网络安全等级保护测评要求》（GB/T 28448-2019），中间件对应该测评项无相关判定需求，因此该项不适用。

### 检测项c

[重要]应通过设定终端接入方式或网络地址范围对通过网络进行管理的管理终端进行限制；

常见结果描述

不适用

- 根据《信息安全技术 网络安全等级保护测评要求》（GB/T 28448-2019），中间件对应该测评项无相关判定需求，因此该项不适用。

### 检测项d

[关键]应提供数据有效性检验功能，保证通过人机接口输入或通过通信接口输入的内容符合系统设定要求；

检测步骤

- 核查渗透扫描报告中，是否存在中间件SQL注入类型等高危漏洞；

- 核查系统设计文档的内容是否包括数据有效性检验功能的内容或模块; 

- 测试验证是否对人机接口或通信接口输入的内容进行有效性检验。

### 检测项e

[重要]应能发现可能存在的已知漏洞，并在经过充分测试评估后，及时修补漏洞；

检测步骤

- 访谈系统管理员是否定期对中间件进行漏洞扫描，查看漏洞扫描报告，核查系统是否存在高风险漏洞；

- 依据漏洞扫描、渗透测试结果，判断中间件是否存在高风险漏洞；

- 访谈系统管理员，中间件补丁更新前是否在测试环境进行测试后才实施更新，更新时严格依据变更流程。

- 核查变更记录和补丁更新制度文件。

### 检测项f

[重要]应能够检测到对重要节点进行入侵的行为，并在发生严重入侵事件时提供报警。

常见结果描述

不适用

- 根据《信息安全技术 网络安全等级保护测评要求》（GB/T 28448-2019），中间件对应该测评项无相关判定需求，因此该项不适用。

## 恶意代码防范

### 检测项a

[重要]应采用免受恶意代码攻击的技术措施或主动免疫可信验证机制及时识别入侵和病毒行为，并将其有效阻断。

常见结果描述

不适用

- 根据《信息安全技术 网络安全等级保护测评要求》（GB/T 28448-2019），中间件对应该测评项无相关判定需求，因此该项不适用。

## 可信验证

### 检测项a

[一般]可基于可信根对计算设备的系统引导程序、系统程序、重要配置参数和应用程序等进行可信验证，并在应用程序的关键执行环节进行动态可信验证，在检测到其可信性受到破坏后进行报警，并将验证结果形成审计记录送至安全管理中心。

常见结果描述

不适用

- 根据《信息安全技术 网络安全等级保护测评要求》（GB/T 28448-2019），中间件对应该测评项无相关判定需求，因此该项不适用。

## 数据完整性

### 检测项a

[重要]应采用校验技术或密码技术保证重要数据在传输过程中的完整性，包括但不限于鉴别数据、重要业务数据、重要审计数据、重要配置数据、重要视频数据和重要个人信息等；

检测步骤

- 使用浏览器查看Tomcat管理控制台或配置文件是否使用HTTPS协议。

### 检测项b

[关键]应采用校验技术或密码技术保证重要数据在存储过程中的完整性，包括但不限于鉴别数据、重要业务数据、重要审计数据、重要配置数据、重要视频数据和重要个人信息等。

常见结果描述

部分符合

- 中间件未采取校验技术或密码技术保证重要审计数据、重要配置数据在存储过程中的完整性。

## 数据保密性

### 检测项a

[关键]应采用密码技术保证重要数据在传输过程中的保密性，包括但不限于鉴别数据、重要业务数据和重要个人信息等；

检测步骤

- 使用浏览器查看Tomcat管理控制台或配置文件是否使用HTTPS协议。

### 检测项b

[关键]应采用密码技术保证重要数据在存储过程中的保密性，包括但不限于鉴别数据、重要业务数据和重要个人信息等。

常见结果描述

部分符合

- 中间件未采取措施确保中间件配置数据在存储过程中的保密性。

## 数据备份恢复

### 检测项a

[关键]应提供重要数据的本地数据备份与恢复功能；

常见结果描述

部分符合

- 中间件未进行恢复测试。

### 检测项b

[重要]应提供异地实时备份功能，利用通信网络将重要数据实时备份至备份场地；

常见结果描述

不符合

- 中间件未提供异地实时备份功能，未利用通信网络将重要数据实时备份至备份场地。

### 检测项c

[关键]应提供重要数据处理系统的热冗余，保证系统的高可用性。

常见结果描述

不适用

- 根据《信息安全技术 网络安全等级保护测评要求》（GB/T 28448-2019），中间件对应该测评项无相关判定需求，因此该项不适用。

## 剩余信息保护

### 检测项a

[重要]应保证鉴别信息所在的存储空间被释放或重新分配前得到完全清除；

常见结果描述

符合

- 经核查，剩余信息保护功能来自于中间件所在操作系统，中间件所在操作系统可以保证鉴别信息所在的存储空间被释放或重新分配前得到完全清除。

### 检测项b

[重要]应保证存有敏感数据的存储空间被释放或重新分配前得到完全清除。

常见结果描述

符合

- 经核查，剩余信息保护功能来自于中间件所在操作系统，中间件所在操作系统可以保证敏感数据所在的存储空间被释放或重新分配前得到完全清除。

## 个人信息保护

### 检测项a

[关键]应仅采集和保存业务必需的用户个人信息；

常见结果描述

不适用

- 根据《信息安全技术 网络安全等级保护测评要求》（GB/T 28448-2019），中间件对应该测评项无相关判定需求，因此该项不适用。

### 检测项b

[关键]应禁止未授权访问和非法使用用户个人信息。

常见结果描述

不适用

- 根据《信息安全技术 网络安全等级保护测评要求》（GB/T 28448-2019），中间件对应该测评项无相关判定需求，因此该项不适用。